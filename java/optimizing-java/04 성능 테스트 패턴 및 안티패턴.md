## 성능 테스트 패턴 및 안티패턴

### 성능 테스트 유형

1. 지연 테스트
    
    가장 일반적인 성능 테스트이다. 그런데 지연 테스트는 사실 양날의 검이다. 이 테스트를 통해 답변하려는 질문이 너무 정량적이고 명확한 나머지 다른 종류의 성능 테스트로 밝히려는 정량적 질문을 식별할 필요성 마저 흐릿하게 만들 수 있기 때문이다. 
    
2. 처리율 테스트
    
    지연 테스트 다음으로 일반적인 성능 테스트이다. 어떤 측면에서 처리율은 지연과 동등한 개념이라고 볼 수 있다. 지연 분포가 갑자기 변하는 시점, 즉 사실상 한계점이 바로 최대 처리율이다. 처리율 테스트는 시스템 성능이 급락하기 직전, 최대 처리율 수치를 측정하는 것이 목표이다.
    
3. 부하 테스트
    
    부하 테스트는 처리율 테스트와는 조금 다르다. 시스템이 이 정도 부하는 견딜 수 있을까, 없을까? 에 대한 YES/NO 를 구하는 것이다. 따라서 신규 고객을 유치하거나 새로운 시장에 진출하기 전, 애플리케이션 트래픽이 상당할 것으로 예상되는 특정 비즈니스 이벤트에 대비하기 위해 부하 테스트를 수행한다.
    
4. 스트레스 테스트
    
    시스템 여력이 어느 정도인지 알아보는 수단이다. 보통 일정한 수준의 트랜잭션, 즉 특정 처리율을 시스템에 계속 걸어놓는다. 시간이 갈수록 서서히 동시 트랜잭션이 중가하고 시스템 성능은 저하된다. 측정값이 나빠지기 시작하기 직전의 값이 최대 처리율이다. 
    
5. 내구 테스트
    
    메모리 누수, 캐시 오염, 메모리 단편화 등 한참 시간이 지나고 나서야 드러나는 문제점은 내구 테스트로 감지한다. 평균 사용률로 시스템에 일정 부하를 계속 주며 모니터링하다가 갑자기 소스가 고갈되거나 시스템이 깨지는 지점을 찾는다. 내구 테스트는 빠른 응답을 요구하는 시스템에서 많이 한다. 
    
6. 용량 계획 테스트
    
    용랑 계획 테스트는 스트레스 테스트와 여러모로 비슷하나, 분명히 구분되는 차이점이 있다. 스트레스 테스트는 현재 시스템이 어느 정도 부하를 버틸 수 있는지 알아보는 반면, 용량 계획 테스트는 업그레이드한 시스템이 어느 정도 부하를 감당할 수 있을지 미리 보는 것이다.  따라서 어떤 이벤트나 위험 요소에 대응하는 것이 아닌, 예정된 계획의 일부분으로 실행하는 경우가 많다. 
    
7. 저하 테스트
    
    부분 실패 테스트라고도 한다. 저하 테스트는 기본적으로 평상시 운영 환경과 동등한 수준의 부하를 시스템에 가하는 도중, 어떤 컴포넌트나 전체 서브시스템이 갑자기 능력을 상실하는 시점에 벌어지는 일들을 확인한다. 저하 테스트 도중 눈여겨 봐야 할 측정값은 트랜잭션 지연 분표와 처리율이다. 저하 테스트 중에는 카오스 멍키라는 하위 유형이 있는데, 이 테스트의 요지는 진짜 복원성 있는 아키텍처에서는 어느 한 컴포넌트가 잘못돼도 다른 컴포넌트까지 연쇄적으로 무너뜨리면서 전체 시스템에 부정적 영향을 끼치는 일은 없어야 한다는 것이다. 
    

### 기본 베스트 프랙티스

성능 튜닝 시 주안점을 두어야 할 부분은 다음 세 가지 기본 원칙에 따라 결정한다.

- 나의 관심사가 무엇인지 식별하고 그 측정 방법을 고민한다.
- 최적화하기 용이한 부분이 아니라, 중요한 부분을 최적화한다.
- 중요한 관심사를 먼저 다룬다.

### 하향식 성능

- 전체 애플리케이션의 성능 양상부터 먼저 알아보는 접근 방식
- 하향식 성능 접근 방식으로 성과를 극대화하려면, 먼저 테스트 환경을 구축한 다음, 무엇을 측정하고 무엇을 최적화해야 하는지, 또 성능 활동을 전체 소프트웨어 개발 주기에서 어떻게 병행해야 하는지, 전 팀원이 명확하게 이해해야 한다.

### 테스트 환경 구축

- 테스트 환경은 가급적 모든 면에서 운영 환경과 똑같이 복제해야 한다.
- 운영 환경과 많이 차이 나는 성능 테스트 환경에서는 실제 환경에서 어떤 일들이 일어날지 예측하기 어렵고 쓸모있는 결과를 얻지 못할 가능성이 크다.

### 성능 요건 식별

성능을 평가하는 지표는 코드 관점에서만 생각해서도 안 되고, 시스템을 전체적으로 바라보며 고객과 경영진에게 중요한 측정값을 고려해야 한다. 이렇게 최적화하려는 핵심 지표를 성능 비기능 요건이라고 한다. 

### 자바의 특정 이슈

성능 분석이라는 과학은 최신 소프트웨어 시스템의 어디에도 적용할 수 있다. 하지만 JVM에는 성능 엔지니어가 잘 이해하고 주의 깊게 살펴야 할 부분들이 있다. 메모리 영역의 동적 튜닝 등 jvm 특유의 다이내믹한 자기 관리 기능이 추가되면서 복잡해졌기 때문이다.

### SDLC 일부로 성능 테스트 수행하기

수준 높은 팀일수록 성능 테스트를 전체 SDLC의 일부로서 수행하며, 특히 성능 회귀 테스트를 상시 수행하는 편이다. 

## 성능 안티패턴 개요

안티패턴은 사람들이 수많은 프로젝트를 수행하면서 밝혀낸, 소프트웨어 프로젝트 또는 팀의 좋지 않은 패턴이다. 

처음엔 뭐가 좋지 않은지 명확하진 않지만 일단 뭔가 조치를 취하긴 해야 할 것 같은 안티패턴도 있고, 시간이 지나면서 서서히 축적된 나쁜 프로젝트 관행의 결과물도 있다. 

성능 튜닝은 항상 초기 기획 단계부터 구체적으로 목표를 정해놓고 시작하는 목표 지향형 프로세스로 접근해야 한다. 물론 말보다 행동이 어렵다. 

다음은 개발자가 잘못된 기술 선택을 하는 지에 대한 5가지의 원인이다.

### 지루함

개발자는 대부분 자기 역할에 지루함을 느끼고 뭔가 새롭고 도전적인 일을 찾지만, 이 개발자의 지루함은 프로젝트에 여러가지로 해악을 끼칠 수 있다. 

### 이력서 부풀리기

본인의 이력서를 과대 포장하기 위해 불필요한 기술을 자꾸 덧대는 개발자가 있다. 이는 아주 오랫동안 시스템에 지대한 영향을 미치게 된다.

### 또래 압박

팀원들이 기술을 결정할 때 관심사를 분명히 밝히지 않고, 서로 충분한 논의 없이 진행하면 프로젝트 결과가 좋지 않다. 

### 이해 부족

지금 사용하고 있는 툴의 기능도 잘 모르는데 무턱대고 새로운 툴로 문제를 해결하려는 개발자가 있다. 그러나 기술 복잡도를 높이는 것과 현재 툴로도 할 수 있는 것 사이의 균형을 잘 맞춰야 한다. 

### 오해와 있지도 않은 문제

문제 자체가 무엇인지 제대로 이해하지 못한 채 오로지 기술을 이용해서 문제를 해결하려는 개발자도 있다. 그러나 성능 수치를 측정도 안 해보고 한다면 성공을 장담할 수 없다. 성능 지표를 수집/분석해야만 비로소 문제의 본질을 정확히 이해할 수 있기 때문이다. 

안티패턴을 예방하려면 팀원 모두 참여해서 기술 이슈를 활발히 공유하는 분위기를 적극 장려해야 한다. 

## 성능 안티패턴 카탈로그

### 화려함에 사로잡히다

- 증상 : 최신의 멋진 기술을 튜닝 타깃으로 정한다.
- 현실 : 신기술에 관한 예제는 보통 작은 규모의 전형적인 데이터셋을 다루기 때문에 기업 규모로 확장하거나 신기술을 제대로 알지 못한 상태에서 문서도 보지 않고 어설프게 적용하면 다른 문제가 불거진다.
- 진단 : 이 안티패턴은 신생팀이나 숙련도가 떨어지는 팀에서 흔하다. 자신의 능력을 증명하려는 욕구에 의해 최신의 뜨고 있는 기술을 숭배한다.
- 처방 : 측정을 해보고 진짜 성능 병목점을 찾고, 새 컴포넌트는 전후로 충분한 로그를 남겨야 한다. 또한 베스트 프랙티스 및 단순화한 데모를 참조하고, 팀원들이 새 기술을 이해하도록 독려하고 팀 차원의 베스트 프랙티스 수준을 정한다.

### 단순함에 사로잡히다

- 증상 : 전체적으로 애플리케이션을 프로파일링해서 객관적으로 아픈 부위를 들추려 하지 않고 무작정 시스템에서 제일 간단한 부분만 파고든다.
- 현실 : 원개발자만 그 시스템 파트를 튜닝하는 방법을 안다. 그리고 다양한 시스템 컴포넌트에 대해 지식 공유를 하지 않고 짝 프로그래밍을 안 한 결과, 독보적인 전문가만 양산된다.
- 진단 : 시스템을 정상 가동시키는 일이 주임무인, 체계가 잘 잡힌 유지보수 팀에서 흔히 나타나는 안티패턴이다. 신기술을 적용하여 새로 병합하려 하면 팀원들은 지레 겁먹고 가급적 새 시스템을 안 맡으려고 한다.
- 처방 : 측정을 해보고 진짜 성능 병목점을 찾고, 본인이 익숙지 않은 컴포넌트에 문제가 생기면 잘 아는 전문가에게 도움을 청해야 한다. 또한 개발자가 전체 시스템 컴포넌트를 고루 이해하도록 독려해야 한다.

### 성능 튜닝 도사

- 증상 : 외부 전문가를 채용해 사내 모든 성능 이슈를 바로잡게 한다.
- 진단 : 스스로 성능 이슈를 해결하기에 실력이 조금 부족하다고 여기는 개발 팀원들이 소외감을 느끼게 한다. 성능 전문가는 대부분 성능 지표를 측정하고 그 결괏값을 바탕으로 문제를 해결하는 사람이다. 특정 이슈를 해결한 방법이나 자기가 알고 있는 걸 공유 안 하려는 전문가를 지향하는 팀원은 매우 반생산적이다.
- 처방 : 측정을 해보고 진짜 성능 병목점을 찾고, 새로 채용된 팀내 전문가가 다른 팀원들과 지식을 공유하고 팀워크를 유지할 수 있게 리드해야 한다.

### 민간 튜닝

- 증상 : 테스트도 안 해본 방법을 바로 적용한다.
- 현실 : 해당 성능 팁의 전후 맥락이나 기초를 모르기 때문에 그 팁이 실제로는 어떤 영향을 미칠지 모른다. 그리고 어떤 시스템에선 통했을지 모르지만, 다른 시스템에 적용해도 효과가 있을지는 모르는 일이다. 오히려 더 나빠질 수도 있다.
- 진단 : 성능 팁은 잘 알려진 문제의 해결 방법을 찾는 과정으로, 유통 기한이 짧아 금세 낡은 유물이 되기 쉽다. 즉 나중에 소프트웨어/플랫폼이 업데이트 되고 누군가 새로운 해결책을 찾아내면 무용지물이 된다는 것이다.
- 처방 : 시스템의 가장 중요한 부분에 직접 영향을 미치는 기술은 확실히 파악하고 충분히 검증돤 것들만 적용해야 한다. 또한 매개변수를 UAT에서 시험해봐야 한다. 그리고 다른 개발자나 데브옵스팀과 함께 설정 문제를 리뷰하고 토의해야 한다.

### 안되면 조상 탓

- 증상 : 이슈와는 아무 상관도 없는 특정 컴포넌트를 문제 삼는다.
- 현실 : 충분히 분석도 안 해보고 성급한 결론을 내린다.
- 진단 : 경영진, 영업팀에서 종종 나타나는 안티패턴이다.
- 처방 : 성급한 결론을 내리지 말고 정상적인 분석을 해야한다. 그리고 그 분석 결과를 모든 이해관계자와 의논해야 한다.

### 숲을 못 보고 나무만 보다

- 증상 : 전체적인 변경 영향도를 완전히 파악하지 않은 채 일단 변경을 해보거나 애플리케이션의 국소적인 부분만 프로파일링한다.
- 현실 : 변경 영향도를 완전히 이해한 사람이 아무도 없다.
- 진단 : 두 가지 사실을 간과해선 안 된다. 첫째 운영계를 그대로 모사한 UAT 환경 없이 최적화의 효용성을 판단하긴 어렵다. 둘째, 부하가 높을 때만 도움이 되고 평소에는 외려 성능을 떨어뜨리는 최적화는 아무 의미 없다. 평상시 서비스 이용 실태를 나타내면서도 부하 집중 시 유의미한 테스트를 제공하는 데이터를 얻기란 어렵다.
- 처방 : 운영계에서 스위치를 변경하기 전 다음 절차를 따라야한다.
    - 운영계 성능 지표를 측정한다.
    - UAT에서 한번에 스위치 하나씩 변경한다.
    - 스트레스를 받는 지점이 UAT와 운영계가 동일한지 확인한다.
    - 운영계에서 일반적인 부하를 나타내는 테스트 데이터를 확보한다.
    - UAT에서 스위치를 변경해 테스트한다.
    - UAT에서 다시 테스트한다.
    - 추론한 내용을 다른 사람에게 재검토 요청한다.
    - 내린 결론을 다른 사람과 공유한다.

### 내 데스크톱이 UAT

- 증상 : UAT 환경이 운영계 환경과 전혀 다른 경우도 많다. 개발자는 그 차이점을 예상하거나 완전히 이해하지 못한 채 저성능 테스크톱에서 고성능 운영 서버로 서비스할 코드를 작성한다.
- 현실 : UAT 환경이 운영계와 달라서 서비스가 중단되는 사태가 벌어지면 장비를 몇 대 더 추가하는 비용보다 훨씬 더 값비싼 대가를 치르게 된다.
- 진단 : 이 안티패턴은 앞서 보았던 것들과는 다른 종류의 인지 편향에 기인한다. 뭐라도 해보는 게 아무것도 안 하는 것보단 낫다고 보는 것이다. 이렇게 근거 없는 낙관주의는 복잡한 기업 환경을 오해하게 만든다. 어떤 식으로든 유의미한 추정을 하려면 UAT 환경을 운영계와 반드시 동기화해야 한다.
- 처방 : 서비스 중단 비용과 고객 이탈로 인한 기회비용을 잘 따져봐야 하고, 운영 환경과 동일한 UAT 환경을 구입해야 한다.

### 운영 데이터처럼 만들기는 어려워

- 증상 : 데이터라이트라고도 하는 이 안티패턴은 사람들이 운영계와 유사한 데이터를 나타내고자 할 때 빠지는 함정이다.
- 현실 : UAT에서 정확한 결과를 얻으려면 운영계 데이터와 최대한 맞춰야 한다.
- 진단 : 이 안티패턴 역시 위에 패턴처럼 근거 없는 낙관주의에 빠지게 한다.
- 처방 : 데이터 도메인 전문가에게 컨설팅을 받고 운영 데이터를 UAT로 다시 이전하는 프로세스에 시간과 노력을 투자해야 한다.

## 인지 편향과 성능 테스트

인간은 원래 정확하고 신속하게 의견을 정리하는 일에 서투르다. 

인지 편향은 인간의 두뇌가 부정확한 결론을 내리게 이끄는 심리 작용이다. 안티패턴도 대부분 전체/부분적으로 하나 이상의 인지 편향으로 비롯된 것들이다. 

각 편향은 이중적 또는 상보적이다. 

### 환원주의

환원주의는 시스템을 아주 작은 조각으로 나누어 그 구성 파트를 이해하면 전체 시스템도 다 이해할 수 있다는 분석주의적 사고방식이다.  그러나 복잡한 시스템은 이 사고방식을 따르지 않는다. 단순히 구성 파트를 합한 것 보다 시스템을 전체로 봐야 문제의 원인을 찾을 수 있다. 

### 확증 편향

확증 편향은 성능 면에서 중대한 문제를 초래하거나, 애플리케이션을 주관적으로 바라보게 한다. 또한 확증 편향은 보통 강력한 동기가 부여되거나 감정 요소가 개입되기 때문에 거스르기 어렵다. 

### 전운의 그림자 (행동 편향)

시스템이 예상대로 작동하지 않는 상황, 또는 아예 중단된 시간 중에 발현되는 편향이다. 평소 로깅, 모니터링을 꾸준히 했다면 명확한 에러 메시지가 생성되므로 금방 원인을 찾아낼 수 있다. 그러나 실패 시나리오를 충분히 테스트 안 해본 상태로 오픈해 로그도 제대로 남기지 않았다면 문제가 많아진다.체계적으로 문제에 접근하는 태도를 길들이지 않으면 문제는 언제든 발생한다. 

### 위험 편향

인간의 본성은 위험을 피하고 변화를 거부한다. 위험 편향은 보통 애플리케이션 문제가 생겼을 때 제대로 학습하고 적절한 조치를 하지 못한 까닭에 더 고착화된다. 

### 엘스버그 역설

엘스버그 역설은 인간이 확률을 이해하는 데 얼마나 서투른지 잘 보여주는 사례이다. 엘스버그는 알려지지 않은 미지의 것보다 알려진 기지의 것을 추구하는 인간 본연의 욕구에 대한 역설을 주장했다.